{"version":3,"file":"package.transform.js","sourceRoot":"","sources":["../../../src/lib/ng-v5/package.transform.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from 'path';\nimport { Observable } from 'rxjs/Observable';\nimport { concat as concatStatic } from 'rxjs/observable/concat';\nimport { fromPromise } from 'rxjs/observable/fromPromise';\nimport { of as observableOf } from 'rxjs/observable/of';\nimport { map, retry, switchMap, takeLast, tap } from 'rxjs/operators';\nimport { pipe } from 'rxjs/util/pipe';\nimport { BuildGraph } from '../brocc/build-graph';\nimport { Node } from '../brocc/node';\nimport { Transform } from '../brocc/transform';\nimport * as log from '../util/log';\nimport { copyFiles } from '../util/copy';\nimport { rimraf } from '../util/rimraf';\nimport { discoverPackages } from './discover-packages';\n\nexport const packageTransformFactory = (project: string, entryPointTransform: Transform) => (\n  source$: Observable<BuildGraph>\n): Observable<BuildGraph> => {\n  const pkgUri = `ng://${project}`;\n\n  return source$.pipe(\n    tap(() => {\n      log.info(`Building Angular Package`);\n    }),\n    // Discover packages and entry points\n    switchMap(graph => {\n      const pkg = discoverPackages({ project });\n\n      return fromPromise(pkg).pipe(\n        map(value => {\n          const ngPkg = new Node(pkgUri);\n          ngPkg.type = 'application/ng-package';\n          ngPkg.data = value;\n\n          return graph.put(ngPkg);\n        })\n      );\n    }),\n    // Clean the primary dest folder (should clean all secondary sub-directory, as well)\n    switchMap(graph => fromPromise(rimraf(graph.get(pkgUri).data.dest)), (graph, _) => graph),\n    // Add entry points to graph\n    map(graph => {\n      const ngPkg = graph.get(pkgUri);\n\n      const entryPoints = [ngPkg.data.primary, ...ngPkg.data.secondaries].map(entryPoint => {\n        // TODO: use `os-tmpdir` instead -> https://www.npmjs.com/package/os-tmpdir\n        // import * as tmpdir from 'os-tempdir'; tmpdir();\n        const stageDir = path.resolve(ngPkg.data.workingDirectory, entryPoint.flatModuleFile, 'stage');\n        const outDir = path.resolve(ngPkg.data.workingDirectory, entryPoint.flatModuleFile, 'out');\n\n        const node = new Node(`ng://${entryPoint.moduleId}`);\n        node.type = 'application/ng-entry-point';\n        node.data = { entryPoint, outDir, stageDir };\n        node.state = 'dirty';\n        node.addDependent(ngPkg);\n\n        return node;\n      });\n\n      return graph.put(entryPoints);\n    }),\n    // Next, run through the entry point transformation\n    switchMap(graph => {\n      const eachEntryPoint$ = graph\n        .filter(node => node.type === 'application/ng-entry-point')\n        .map(() => observableOf(graph).pipe(entryPointTransform));\n\n      return concatStatic(...eachEntryPoint$).pipe(takeLast(1));\n    }),\n    // Write npm package to dest folder\n    writeNpmPackage(pkgUri),\n    tap(graph => {\n      const ngPkg = graph.get(pkgUri);\n      log.success(`Built Angular Package!\n- from: ${ngPkg.data.src}\n- to:   ${ngPkg.data.dest}`);\n    })\n  );\n};\n\nconst writeNpmPackage = (pkgUri: string): Transform =>\n  pipe(\n    switchMap(graph => {\n      const ngPkg = graph.get(pkgUri);\n\n      return fromPromise(\n        Promise.all([\n          copyFiles(`${ngPkg.data.src}/README.md`, ngPkg.data.dest),\n          copyFiles(`${ngPkg.data.src}/LICENSE`, ngPkg.data.dest),\n          rimraf(ngPkg.data.workingDirectory)\n        ])\n      ).pipe(map(() => graph));\n    })\n  );\n"]}