{"version":3,"file":"entry-point.transform.js","sourceRoot":"","sources":["../../../src/lib/ng-v5/entry-point.transform.ts"],"names":[],"mappings":";;;;;;;;;;AAKA,yCAAsC;AAGtC,kDAAqE;AACrE,mCAAmC;AACnC,2CAAwC;AAExC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;GAqCG;AACU,QAAA,0BAA0B,GAAG,CACxC,YAAuB,EACvB,gBAA2B,EAC3B,iBAA4B,EAC5B,eAA0B,EAC1B,kBAA6B,EAC7B,SAAoB,EACpB,YAAuB,EACvB,kBAA6B,EAC7B,YAAuB,EACZ,EAAE,CACb,WAAI;AACF,+DAA+D;AAE/D,gCAAoB,CAAC,CAAM,KAAK,EAAC,EAAE;IACjC,4CAA4C;IAC5C,MAAM,UAAU,GAAG,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,IAAI,KAAK,4BAA4B,IAAI,IAAI,CAAC,KAAK,KAAK,OAAO,CAAC,CAAC;IAE5G,wCAAwC;IACxC,UAAU,CAAC,KAAK,GAAG,aAAa,CAAC;IACjC,GAAG,CAAC,IAAI,CAAC,yBAAyB,UAAU,CAAC,IAAI,CAAC,UAAU,CAAC,QAAQ,GAAG,CAAC,CAAC;IAE1E,wBAAwB;IACxB,MAAM,KAAK,CAAC,UAAU,CAAC,IAAI,CAAC,QAAQ,EAAE,UAAU,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;AAChE,CAAC,CAAA,CAAC;AACF,iCAAiC;AACjC,YAAY,EACZ,gBAAgB,EAChB,iBAAiB,EACjB,eAAe,EACf,kBAAkB,EAClB,SAAS;AACT,+CAA+C;AAC/C,WAAI,CAAC,YAAY,EAAE,kBAAkB,EAAE,YAAY,CAAC,EAEpD,gCAAoB,CAAC,CAAM,KAAK,EAAC,EAAE;IACjC,MAAM,UAAU,GAAG,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,IAAI,KAAK,4BAA4B,IAAI,IAAI,CAAC,KAAK,KAAK,aAAa,CAAC,CAAC;IAClH,UAAU,CAAC,KAAK,GAAG,MAAM,CAAC;AAC5B,CAAC,CAAA,CAAC;AAEF,+BAA+B;CAChC,CAAC;AAEJ,eAAqB,GAAG,KAAe;;QACrC,GAAG,CAAC,IAAI,CAAC,0BAA0B,CAAC,CAAC;QACrC,GAAG,CAAC,CAAC,IAAI,IAAI,IAAI,KAAK,CAAC,CAAC,CAAC;YACvB,MAAM,eAAM,CAAC,IAAI,CAAC,CAAC;QACrB,CAAC;IACH,CAAC;CAAA","sourcesContent":["import { InjectionToken, FactoryProvider, ValueProvider } from 'injection-js';\nimport { Observable } from 'rxjs/Observable';\nimport { of as observableOf } from 'rxjs/observable/of';\nimport { fromPromise } from 'rxjs/observable/fromPromise';\nimport { map, switchMap, tap } from 'rxjs/operators';\nimport { pipe } from 'rxjs/util/pipe';\nimport { BuildGraph } from '../brocc/build-graph';\nimport { Node } from '../brocc/node';\nimport { Transform, transformFromPromise } from '../brocc/transform';\nimport * as log from '../util/log';\nimport { rimraf } from '../util/rimraf';\n\n/**\n * A re-write of the `transformSources()` script that transforms an entry point from sources to distributable format.\n *\n * Sources are TypeScript source files accompanied by HTML templates and xCSS stylesheets.\n * See the Angular Package Format for a detailed description of what the distributables include.\n *\n * The current transformation pipeline can be thought of as:\n *\n *  - clean\n *  - initTsConfig\n *  - analyzeTsSources (thereby extracting template and stylesheet files)\n *  - renderTemplates\n *  - renderStylesheets\n *  - transformTsSources (thereby inlining template and stylesheet data)\n *  - compileTs\n *  - writeBundles\n *    - bundleToFesm15\n *    - bundleToFesm5\n *    - bundleToUmd\n *    - bundleToUmdMin\n *  - relocateSourceMaps\n *  - writePackage\n *   - copyStagedFiles (bundles, esm, dts, metadata, sourcemaps)\n *   - writePackageJson\n *\n * The transformation pipeline is pluggable through the dependency injection system.\n * Sub-transformations are passed to this factory function as arguments.\n *\n * @param initTsConfig Transformation initializing the tsconfig of the entry point.\n * @param analyzeTsSources Transformation analyzing the typescript source files of the entry point.\n * @param renderTemplates Transformation rendering HTML templates.\n * @param renderStylesheets Transformation rendering xCSS stylesheets.\n * @param transformTsSources Transformation manipulating the typescript source files (thus inlining template and stylesheet data).\n * @param compileTs Transformation compiling typescript sources to ES2015 modules.\n * @param writeBundles Transformation flattening ES2015 modules to ESM2015, ESM5, UMD, and minified UMD.\n * @param relocateSourceMaps Transformation re-locating (adapting) paths in the source maps.\n * @param writePackage Transformation writing a distribution-ready `package.json` (for publishing to npm registry).\n */\nexport const entryPointTransformFactory = (\n  initTsConfig: Transform,\n  analyzeTsSources: Transform,\n  renderStylesheets: Transform,\n  renderTemplates: Transform,\n  transformTsSources: Transform,\n  compileTs: Transform,\n  writeBundles: Transform,\n  relocateSourceMaps: Transform,\n  writePackage: Transform\n): Transform =>\n  pipe(\n    //tap(() => log.info(`Building from sources for entry point`)),\n\n    transformFromPromise(async graph => {\n      // Peek the first entry point from the graph\n      const entryPoint = graph.find(node => node.type === 'application/ng-entry-point' && node.state === 'dirty');\n\n      // Mark the entry point as 'in-progress'\n      entryPoint.state = 'in-progress';\n      log.info(`Building entry point '${entryPoint.data.entryPoint.moduleId}'`);\n\n      // Clean build directory\n      await clean(entryPoint.data.stageDir, entryPoint.data.outDir);\n    }),\n    // TypeScript sources compilation\n    initTsConfig,\n    analyzeTsSources,\n    renderStylesheets,\n    renderTemplates,\n    transformTsSources,\n    compileTs,\n    // After TypeScript: bundling and write package\n    pipe(writeBundles, relocateSourceMaps, writePackage),\n\n    transformFromPromise(async graph => {\n      const entryPoint = graph.find(node => node.type === 'application/ng-entry-point' && node.state === 'in-progress');\n      entryPoint.state = 'done';\n    })\n\n    //tap(() => log.info(`Built.`))\n  );\n\nasync function clean(...paths: string[]) {\n  log.info('Cleaning build directory');\n  for (let path of paths) {\n    await rimraf(path);\n  }\n}\n"]}